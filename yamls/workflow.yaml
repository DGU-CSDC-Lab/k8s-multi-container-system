# 학습 workflow 정의
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: protogcn-run-
spec:
  entrypoint: run
  imagePullSecrets:        # 전체 템플릿에 적용
    - name: dockerhub-secret
  arguments:
    parameters:
    - name: user

  volumes:
  - name: shared-volume
    persistentVolumeClaim:
      claimName: protogcn-pvc

  templates:
  - name: run
    dag:
      tasks:
      - name: train
        template: train-one
        arguments:
          parameters:
            - name: pkl_path
              value: "/data/data/*/*.pkl"  # 하위 폴더의 pkl 파일들
            - name: output_dir
              value: "/data/results/{{workflow.parameters.user}}"

  - name: train-one
    inputs:
      parameters:
      - name: pkl_path
      - name: output_dir
    container:
      image: python:3.8-slim
      command: ["sh", "-c"]
      args: ["cd /data && pip install -r requirements.txt && pip install -e . && python auto_protogcn.py"]
      resources:
        limits:
          nvidia.com/gpu: 1
        requests:
          nvidia.com/gpu: 1
      env:
      - name: DATASET_PKL
        value: "{{inputs.parameters.pkl_path}}"
      - name: RUNS_ROOT
        value: "{{inputs.parameters.output_dir}}"
      - name: NVIDIA_VISIBLE_DEVICES
        value: "0"
      - name: RANK
        value: "0"
      - name: WORLD_SIZE
        value: "1"
      - name: LOCAL_RANK
        value: "0"
      - name: MASTER_ADDR
        value: "localhost"
      - name: MASTER_PORT
        value: "29500"
      volumeMounts:
      - name: shared-volume
        mountPath: /data
      - name: dev-nvidia0
        mountPath: /dev/nvidia0
      - name: dev-nvidiactl
        mountPath: /dev/nvidiactl
      - name: dev-nvidia-uvm
        mountPath: /dev/nvidia-uvm
      - name: nvidia-libs
        mountPath: /usr/lib/x86_64-linux-gnu
        readOnly: true
    volumes:
    - name: dev-nvidia0
      hostPath:
        path: /dev/nvidia0
    - name: dev-nvidiactl
      hostPath:
        path: /dev/nvidiactl
    - name: dev-nvidia-uvm
      hostPath:
        path: /dev/nvidia-uvm
    - name: nvidia-libs
      hostPath:
        path: /usr/lib/x86_64-linux-gnu

  # 3. CSV 병합
  - name: merge-results
    container:
      image: bianbbc87/csdc-protogcn-merge:latest
      command: ["python", "/app/index.py"]
      volumeMounts:
      - name: shared-volume
        mountPath: /data
