# 학습 workflow 정의
apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: protogcn-run-
spec:
  entrypoint: run
  imagePullSecrets:        # 전체 템플릿에 적용
    - name: dockerhub-secret
  arguments:
    parameters:
    - name: user

  volumes:
  - name: shared-volume
    persistentVolumeClaim:
      claimName: protogcn-pvc

  templates:
  - name: run
    dag:
      tasks:
      - name: train
        template: train-one
        arguments:
          parameters:
            - name: pkl_path
              value: "/data/proto-gcn/data/*.pkl"  # Ubuntu 환경에 맞게 수정
            - name: output_dir
              value: "/data/results/{{workflow.parameters.user}}"

  - name: train-one
    inputs:
      parameters:
      - name: pkl_path
      - name: output_dir
    container:
      image: python:3.9-slim
      command: ["sh", "-c"]
      args: ["cd /data/proto-gcn && python auto_protogcn.py"]
      imagePullPolicy: IfNotPresent
      env:
      - name: DATASET_PKL
        value: "{{inputs.parameters.pkl_path}}"
      - name: RUNS_ROOT
        value: "{{inputs.parameters.output_dir}}"
      volumeMounts:
      - name: shared-volume
        mountPath: /data

  # 3. CSV 병합
  - name: merge-results
    container:
      image: bianbbc87/csdc-protogcn-merge:latest
      command: ["python", "/app/index.py"]
      volumeMounts:
      - name: shared-volume
        mountPath: /data
