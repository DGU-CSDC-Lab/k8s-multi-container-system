<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8">
    <title>ProtoGCN UI</title>
    <link rel="stylesheet" href="/static/style.css">
    <style>
        #loading {
            display: none;
            font-style: italic;
            color: gray;
        }
    </style>
</head>

<body>
    <h2>ProtoGCN 병렬 Workflow UI</h2>
    <h3>1. 영문 이름을 입력해주세요.</h3>
    파일 기록 용으로 사용됩니다.
    <br><br>
    <form id="upload-form" enctype="multipart/form-data">
        <input type="text" id="user-id" name="user" placeholder="User ID" required>
        <h3>2. 업로드할 pkl 파일을 선택해주세요.</h3>
        파일 크기에 따라 시간이 소요될 수 있습니다.
        <input type="file" name="files" multiple required>
        <button type="submit" id="upload-btn">완료</button>
    </form>
    <div id="loading">업로드 중.....</div>
    <div id="upload-result"></div>

    <h3>3. Run 을 눌러 학습 시키세요.</h3>
    http://192.168.0.62:2749 주소로 접속 후 Argo UI에서 진행 상황을 모니터링 할 수 있습니다.
    <button onclick="runWorkflow()" id="run-btn">Run</button>
    <pre id="workflow-result"></pre>

    <h3>4. Summary CSV를 다운 받으세요.</h3>
    <button onclick="loadSummary()" id="summary-btn">요약 로드</button>
    <pre id="summary-table"></pre>
    <a id="download-link" href="#" download style="display:none">CSV 다운로드</a>

    <script>
        const userInput = document.getElementById("user-id");
        const loading = document.getElementById("loading");

        const showLoading = (msg = "Working...") => {
            loading.textContent = msg;
            loading.style.display = "block";
        };
        const hideLoading = () => {
            loading.style.display = "none";
        };

        document.getElementById('upload-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const form = e.target;
            const data = new FormData();
            data.append("user", userInput.value);
            for (const file of form.files.files) {
                data.append("files", file);
            }

            document.getElementById("upload-btn").disabled = true;
            showLoading("Uploading files...");

            try {
                const res = await fetch("/upload-multi", {
                    method: "POST",
                    body: data
                });
                const result = await res.json();
                document.getElementById("upload-result").innerText = JSON.stringify(result, null, 2);
            } catch (err) {
                document.getElementById("upload-result").innerText = "Upload failed: " + err;
            } finally {
                hideLoading();
                document.getElementById("upload-btn").disabled = false;
            }
        });

        async function runWorkflow() {
            const data = new FormData();
            data.append("user", userInput.value);
            document.getElementById("run-btn").disabled = true;
            showLoading("Submitting workflow...");

            try {
                const res = await fetch("/run", {
                    method: "POST",
                    body: data
                });
                const result = await res.json();
                document.getElementById("workflow-result").innerText = JSON.stringify(result, null, 2);
            } catch (err) {
                document.getElementById("workflow-result").innerText = "Workflow submission failed: " + err;
            } finally {
                hideLoading();
                document.getElementById("run-btn").disabled = false;
            }
        }

        async function loadSummary() {
            const user = userInput.value;
            showLoading("Loading summary...");

            try {
                const res = await fetch(`/summary/${user}`);
                if (res.ok) {
                    const text = await res.text();
                    document.getElementById("summary-table").textContent = text;
                    const blob = new Blob([text], { type: "text/csv" });
                    const url = URL.createObjectURL(blob);
                    const link = document.getElementById("download-link");
                    link.href = url;
                    link.style.display = 'inline';
                    link.download = `summary-${user}.csv`;
                } else {
                    document.getElementById("summary-table").textContent = "No summary found.";
                }
            } catch (err) {
                document.getElementById("summary-table").textContent = "Error loading summary: " + err;
            } finally {
                hideLoading();
            }
        }
    </script>
</body>

</html>